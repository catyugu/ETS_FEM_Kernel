# 性能优化记录 (OPTIM_ROUTINE.md)

本文档记录了 `ETS_FEM_Kernel` 项目在开发过程中的各项性能优化尝试，旨在跟踪优化措施、评估其效果并为未来的工作提供参考。

---

## 优化尝试 #1: 使用 Triplet 列表优化矩阵组装

* **日期**: 2025-08-22
* **目标**: 提高全局稀疏矩阵（刚度矩阵 `K_global_`）组装过程的效率。
* **措施**:
  将原有的组装逻辑（通过 `coeffRef` 直接对稀疏矩阵的非零元进行逐点读写和累加）修改为使用 `std::vector<Eigen::Triplet<T>>` 列表。新的工作流程如下：
    1.  在 `assemble` 阶段开始时，创建一个 `triplet_list`。
    2.  根据稀疏模式预计算结果，为 `triplet_list` `reserve` 空间。
    3.  遍历所有单元（Element）和边界，计算出的局部矩阵非零元以 `(row, col, value)` 的形式 `emplace_back` 到 `triplet_list` 中。
    4.  在所有计算完成后，调用一次 `K_global_.setFromTriplets()` 方法，通过迭代器高效地构建整个稀疏矩阵。
* **理论优势**: 避免了在循环中对稀疏矩阵进行低效的随机访问和可能的内存重分配，将复杂的写操作转为简单的线性内存追加，最后进行一次性的高效构建。

### **性能分析报告**

以下是应用此优化后，在一次典型测试运行中生成的**完整**性能报告：

```text
=== Performance Profiling Report ===
Total elapsed time: 810.468 ms
--------------------------------------------------------------------------------------------------------------
Function/Scope                                            Calls  Total (ms)   Self (ms) Avg (ms) Min (ms) Max (ms) Pct (%)
--------------------------------------------------------------------------------------------------------------
Test::PostProcessing                                          1     326.613     326.613  326.613  326.613  326.613   40.3%
FEM::Problem<3,double>::assemble                              3     218.325     156.076   72.775    5.366  207.440   19.3%
FEM::LinearSolver::solve                                      7     116.197     116.197   16.600    0.025  112.702   14.3%
Test::Input                                                   1     113.156     113.156  113.156  113.156  113.156   14.0%
FEM::FEValues::FEValues                                   47662      63.053      63.053    0.001    0.001    0.099    7.8%
FEM::Problem<3,double>::applyDirichletBCs                     3      25.235      25.235    8.412    0.254   24.726    3.1%
FEM::Problem<2,double>::assemble                              2       1.859       1.121    0.929    0.925    0.934    0.1%
Test::SetupPhysics                                            1       0.877       0.877    0.877    0.877    0.877    0.1%
FEM::Problem<1,double>::assemble                              2       0.143       0.077    0.071    0.046    0.096    0.0%
FEM::Problem<2,double>::applyDirichletBCs                     2       0.063       0.063    0.032    0.030    0.034    0.0%
FEM::Problem<1,double>::applyDirichletBCs                     2       0.011       0.011    0.005    0.002    0.009    0.0%

```

### **结果分析 (聚焦于内核性能)**

在本次分析中，我们忽略与测试框架相关的开销（即 `Test::` 为前缀的条目），仅关注 `FEM::` 命名空间下的内核函数性能。

* **内核核心瓶颈**: `ETS_FEM_Kernel` 的核心性能瓶颈清晰地体现在**矩阵组装 (`assemble`)** 和 **线性求解 (`solve`)** 两个环节。
* **组装 (`assemble`)**:
    * 三维问题的组装函数 `FEM::Problem<3,double>::assemble` 是目前内核中最大的耗时点。其自身耗时 (`Self`) 为 **156.076 ms**。
    * 在组装过程中，`FEM::FEValues` 的构造和计算是主要的开销来源。它被频繁调用（47662次），累计耗时 **63.053 ms**。
* **求解 (`solve`)**: `FEM::LinearSolver::solve` 是第二大性能瓶颈，耗时 **116.197 ms**。这凸显了选择和优化求解器策略的重要性。
* **边界条件**: 狄利克雷边界条件的处理 (`applyDirichletBCs`) 在三维问题中也占有一定比重，耗时 **25.235 ms**。

