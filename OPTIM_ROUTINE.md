# 性能优化记录 (OPTIM_ROUTINE.md)

本文档记录了 `ETS_FEM_Kernel` 项目在开发过程中的各项性能优化尝试，旨在跟踪优化措施、评估其效果并为未来的工作提供参考。

---

## 优化尝试 #1: 使用 Triplet 列表优化矩阵组装

* **日期**: 2025-08-22
* **目标**: 提高全局稀疏矩阵（刚度矩阵 `K_global_`）组装过程的效率。
* **措施**:
  将原有的组装逻辑（通过 `coeffRef` 直接对稀疏矩阵的非零元进行逐点读写和累加）修改为使用 `std::vector<Eigen::Triplet<T>>` 列表。新的工作流程如下：
    1.  在 `assemble` 阶段开始时，创建一个 `triplet_list`。
    2.  根据稀疏模式预计算结果，为 `triplet_list` `reserve` 空间。
    3.  遍历所有单元（Element）和边界，计算出的局部矩阵非零元以 `(row, col, value)` 的形式 `emplace_back` 到 `triplet_list` 中。
    4.  在所有计算完成后，调用一次 `K_global_.setFromTriplets()` 方法，通过迭代器高效地构建整个稀疏矩阵。
* **理论优势**: 避免了在循环中对稀疏矩阵进行低效的随机访问和可能的内存重分配，将复杂的写操作转为简单的线性内存追加，最后进行一次性的高效构建。

### **性能分析报告**

以下是应用此优化后，在一次典型测试运行中生成的**完整**性能报告：

```text
=== Performance Profiling Report ===
Total elapsed time: 5791.118 ms
--------------------------------------------------------------------------------------------------------------
Function/Scope                                       Calls  Total (ms)   Self (ms) Avg (ms) Min (ms) Max (ms) Pct (%)
--------------------------------------------------------------------------------------------------------------
Test::PostProcessing                                     1    3187.204    3187.204 3187.204 3187.204 3187.204   55.0%
FEM::LinearSolver::solve                                 1    1154.626    1154.626 1154.626 1154.626 1154.626   19.9%
FEM::Problem<3,double>::assemble                         1     868.037     628.501  868.037  868.037  868.037   10.9%
Test::Input                                              1     412.041     412.041  412.041  412.041  412.041    7.1%
FEM::FEValues::FEValues                             165124     239.536     239.536    0.001    0.001    1.849    4.1%
FEM::Problem<3,double>::applyDirichletBCs                1     146.503     146.503  146.503  146.503  146.503    2.5%
Test::SetupPhysics                                       1       2.794       2.794    2.794    2.794    2.794    0.0%

```

### **结果分析 (聚焦于内核性能)**

在本次分析中，我们忽略与测试框架相关的开销（即 `Test::` 为前缀的条目），仅关注 `FEM::` 命名空间下的内核函数性能。

* **内核核心瓶颈**: `ETS_FEM_Kernel` 的核心性能瓶颈清晰地体现在**矩阵组装 (`assemble`)** 和 **线性求解 (`solve`)** 两个环节。
* **组装 (`assemble`)**:
    * 三维问题的组装函数 `FEM::Problem<3,double>::assemble` 是目前内核中一大耗时点。其自身耗时 (`Self`) 为 **868.037 ms**。
    * 在组装过程中，`FEM::FEValues` 的构造和计算是主要的开销来源。它被频繁调用（165124），累计耗时 **239.536 ms**。
* **求解 (`solve`)**: `FEM::LinearSolver::solve` 是第二大性能瓶颈，耗时 **1154.626 ms**。这凸显了选择和优化求解器策略的重要性。
* **边界条件**: 狄利克雷边界条件的处理 (`applyDirichletBCs`) 在三维问题中也占有一定比重，耗时 **146.503 ms**。

